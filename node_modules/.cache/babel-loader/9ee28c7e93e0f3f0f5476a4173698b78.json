{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n/**\n * @module ol/reproj/Image\n */\n\n\nimport { ERROR_THRESHOLD } from './common.js';\nimport EventType from '../events/EventType.js';\nimport ImageBase from '../ImageBase.js';\nimport ImageState from '../ImageState.js';\nimport Triangulation from './Triangulation.js';\nimport { calculateSourceResolution, render as renderReprojected } from '../reproj.js';\nimport { getCenter, getHeight, getIntersection, getWidth } from '../extent.js';\nimport { listen, unlistenByKey } from '../events.js';\n/**\n * @typedef {function(import(\"../extent.js\").Extent, number, number) : import(\"../ImageBase.js\").default} FunctionType\n */\n\n/**\n * @classdesc\n * Class encapsulating single reprojected image.\n * See {@link module:ol/source/Image~ImageSource}.\n */\n\nvar ReprojImage =\n/** @class */\nfunction (_super) {\n  __extends(ReprojImage, _super);\n  /**\n   * @param {import(\"../proj/Projection.js\").default} sourceProj Source projection (of the data).\n   * @param {import(\"../proj/Projection.js\").default} targetProj Target projection.\n   * @param {import(\"../extent.js\").Extent} targetExtent Target extent.\n   * @param {number} targetResolution Target resolution.\n   * @param {number} pixelRatio Pixel ratio.\n   * @param {FunctionType} getImageFunction\n   *     Function returning source images (extent, resolution, pixelRatio).\n   * @param {boolean} interpolate Use linear interpolation when resampling.\n   */\n\n\n  function ReprojImage(sourceProj, targetProj, targetExtent, targetResolution, pixelRatio, getImageFunction, interpolate) {\n    var _this = this;\n\n    var maxSourceExtent = sourceProj.getExtent();\n    var maxTargetExtent = targetProj.getExtent();\n    var limitedTargetExtent = maxTargetExtent ? getIntersection(targetExtent, maxTargetExtent) : targetExtent;\n    var targetCenter = getCenter(limitedTargetExtent);\n    var sourceResolution = calculateSourceResolution(sourceProj, targetProj, targetCenter, targetResolution);\n    var errorThresholdInPixels = ERROR_THRESHOLD;\n    var triangulation = new Triangulation(sourceProj, targetProj, limitedTargetExtent, maxSourceExtent, sourceResolution * errorThresholdInPixels, targetResolution);\n    var sourceExtent = triangulation.calculateSourceExtent();\n    var sourceImage = getImageFunction(sourceExtent, sourceResolution, pixelRatio);\n    var state = sourceImage ? ImageState.IDLE : ImageState.EMPTY;\n    var sourcePixelRatio = sourceImage ? sourceImage.getPixelRatio() : 1;\n    _this = _super.call(this, targetExtent, targetResolution, sourcePixelRatio, state) || this;\n    /**\n     * @private\n     * @type {import(\"../proj/Projection.js\").default}\n     */\n\n    _this.targetProj_ = targetProj;\n    /**\n     * @private\n     * @type {import(\"../extent.js\").Extent}\n     */\n\n    _this.maxSourceExtent_ = maxSourceExtent;\n    /**\n     * @private\n     * @type {!import(\"./Triangulation.js\").default}\n     */\n\n    _this.triangulation_ = triangulation;\n    /**\n     * @private\n     * @type {number}\n     */\n\n    _this.targetResolution_ = targetResolution;\n    /**\n     * @private\n     * @type {import(\"../extent.js\").Extent}\n     */\n\n    _this.targetExtent_ = targetExtent;\n    /**\n     * @private\n     * @type {import(\"../ImageBase.js\").default}\n     */\n\n    _this.sourceImage_ = sourceImage;\n    /**\n     * @private\n     * @type {number}\n     */\n\n    _this.sourcePixelRatio_ = sourcePixelRatio;\n    /**\n     * @private\n     * @type {boolean}\n     */\n\n    _this.interpolate_ = interpolate;\n    /**\n     * @private\n     * @type {HTMLCanvasElement}\n     */\n\n    _this.canvas_ = null;\n    /**\n     * @private\n     * @type {?import(\"../events.js\").EventsKey}\n     */\n\n    _this.sourceListenerKey_ = null;\n    return _this;\n  }\n  /**\n   * Clean up.\n   */\n\n\n  ReprojImage.prototype.disposeInternal = function () {\n    if (this.state == ImageState.LOADING) {\n      this.unlistenSource_();\n    }\n\n    _super.prototype.disposeInternal.call(this);\n  };\n  /**\n   * @return {HTMLCanvasElement} Image.\n   */\n\n\n  ReprojImage.prototype.getImage = function () {\n    return this.canvas_;\n  };\n  /**\n   * @return {import(\"../proj/Projection.js\").default} Projection.\n   */\n\n\n  ReprojImage.prototype.getProjection = function () {\n    return this.targetProj_;\n  };\n  /**\n   * @private\n   */\n\n\n  ReprojImage.prototype.reproject_ = function () {\n    var sourceState = this.sourceImage_.getState();\n\n    if (sourceState == ImageState.LOADED) {\n      var width = getWidth(this.targetExtent_) / this.targetResolution_;\n      var height = getHeight(this.targetExtent_) / this.targetResolution_;\n      this.canvas_ = renderReprojected(width, height, this.sourcePixelRatio_, this.sourceImage_.getResolution(), this.maxSourceExtent_, this.targetResolution_, this.targetExtent_, this.triangulation_, [{\n        extent: this.sourceImage_.getExtent(),\n        image: this.sourceImage_.getImage()\n      }], 0, undefined, this.interpolate_);\n    }\n\n    this.state = sourceState;\n    this.changed();\n  };\n  /**\n   * Load not yet loaded URI.\n   */\n\n\n  ReprojImage.prototype.load = function () {\n    if (this.state == ImageState.IDLE) {\n      this.state = ImageState.LOADING;\n      this.changed();\n      var sourceState = this.sourceImage_.getState();\n\n      if (sourceState == ImageState.LOADED || sourceState == ImageState.ERROR) {\n        this.reproject_();\n      } else {\n        this.sourceListenerKey_ = listen(this.sourceImage_, EventType.CHANGE, function (e) {\n          var sourceState = this.sourceImage_.getState();\n\n          if (sourceState == ImageState.LOADED || sourceState == ImageState.ERROR) {\n            this.unlistenSource_();\n            this.reproject_();\n          }\n        }, this);\n        this.sourceImage_.load();\n      }\n    }\n  };\n  /**\n   * @private\n   */\n\n\n  ReprojImage.prototype.unlistenSource_ = function () {\n    unlistenByKey(\n    /** @type {!import(\"../events.js\").EventsKey} */\n    this.sourceListenerKey_);\n    this.sourceListenerKey_ = null;\n  };\n\n  return ReprojImage;\n}(ImageBase);\n\nexport default ReprojImage;","map":{"version":3,"mappings":"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","names":["ERROR_THRESHOLD","EventType","ImageBase","ImageState","Triangulation","calculateSourceResolution","render","renderReprojected","getCenter","getHeight","getIntersection","getWidth","listen","unlistenByKey","__extends","sourceProj","targetProj","targetExtent","targetResolution","pixelRatio","getImageFunction","interpolate","maxSourceExtent","getExtent","maxTargetExtent","limitedTargetExtent","targetCenter","sourceResolution","errorThresholdInPixels","triangulation","sourceExtent","calculateSourceExtent","sourceImage","state","IDLE","EMPTY","sourcePixelRatio","getPixelRatio","_super","_this","targetProj_","maxSourceExtent_","triangulation_","targetResolution_","targetExtent_","sourceImage_","sourcePixelRatio_","interpolate_","canvas_","sourceListenerKey_","ReprojImage","LOADING","unlistenSource_","disposeInternal","call","sourceState","getState","LOADED","width","height","getResolution","extent","image","getImage","undefined","changed","ERROR","reproject_","CHANGE","e","load"],"sourceRoot":"","sources":["../src/reproj/Image.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}
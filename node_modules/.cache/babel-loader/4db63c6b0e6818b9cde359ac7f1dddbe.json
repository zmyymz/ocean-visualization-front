{"ast":null,"code":"import \"core-js/modules/es.array.find-index.js\";\nimport { nextTick } from 'vue';\nimport '../../utils/index.mjs';\nimport '../../constants/index.mjs';\nimport { EVENT_CODE } from '../../constants/aria.mjs';\nimport { obtainAllFocusableElements } from '../../utils/dom/aria.mjs';\nimport { on, off } from '../../utils/dom/event.mjs';\nvar FOCUSABLE_CHILDREN = \"_trap-focus-children\";\nvar TRAP_FOCUS_HANDLER = \"_trap-focus-handler\";\nvar FOCUS_STACK = [];\n\nvar FOCUS_HANDLER = function FOCUS_HANDLER(e) {\n  var _a;\n\n  if (FOCUS_STACK.length === 0) return;\n  var focusableElement = FOCUS_STACK[FOCUS_STACK.length - 1][FOCUSABLE_CHILDREN];\n\n  if (focusableElement.length > 0 && e.code === EVENT_CODE.tab) {\n    if (focusableElement.length === 1) {\n      e.preventDefault();\n\n      if (document.activeElement !== focusableElement[0]) {\n        focusableElement[0].focus();\n      }\n\n      return;\n    }\n\n    var goingBackward = e.shiftKey;\n    var isFirst = e.target === focusableElement[0];\n    var isLast = e.target === focusableElement[focusableElement.length - 1];\n\n    if (isFirst && goingBackward) {\n      e.preventDefault();\n      focusableElement[focusableElement.length - 1].focus();\n    }\n\n    if (isLast && !goingBackward) {\n      e.preventDefault();\n      focusableElement[0].focus();\n    }\n\n    if (process.env.NODE_ENV === \"test\") {\n      var index = focusableElement.findIndex(function (element) {\n        return element === e.target;\n      });\n\n      if (index !== -1) {\n        (_a = focusableElement[goingBackward ? index - 1 : index + 1]) == null ? void 0 : _a.focus();\n      }\n    }\n  }\n};\n\nvar TrapFocus = {\n  beforeMount: function beforeMount(el) {\n    el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el);\n    FOCUS_STACK.push(el);\n\n    if (FOCUS_STACK.length <= 1) {\n      on(document, \"keydown\", FOCUS_HANDLER);\n    }\n  },\n  updated: function updated(el) {\n    nextTick(function () {\n      el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el);\n    });\n  },\n  unmounted: function unmounted() {\n    FOCUS_STACK.shift();\n\n    if (FOCUS_STACK.length === 0) {\n      off(document, \"keydown\", FOCUS_HANDLER);\n    }\n  }\n};\nexport { FOCUSABLE_CHILDREN, TRAP_FOCUS_HANDLER, TrapFocus as default };","map":{"version":3,"mappings":";;;;;;;AAGY,IAACA,kBAAkB,GAAG,sBAAtB;AACA,IAACC,kBAAkB,GAAG,qBAAtB;AACZ,IAAMC,WAAW,GAAG,EAApB;;AACA,IAAMC,aAAa,GAAG,SAAhBA,aAAgB,CAACC,CAAD,EAAO;AAC3B,MAAIC,EAAJ;;AACA,MAAIH,WAAW,CAACI,MAAZ,KAAuB,CAA3B,EACE;AACF,MAAMC,gBAAgB,GAAGL,WAAW,CAACA,WAAW,CAACI,MAAZ,GAAqB,CAAtB,CAAX,CAAoCN,kBAApC,CAAzB;;AACA,MAAIO,gBAAgB,CAACD,MAAjB,GAA0B,CAA1B,IAA+BF,CAAC,CAACI,IAAF,KAAWC,UAAU,CAACC,GAAzD,EAA8D;AAC5D,QAAIH,gBAAgB,CAACD,MAAjB,KAA4B,CAAhC,EAAmC;AACjCF,OAAC,CAACO,cAAF;;AACA,UAAIC,QAAQ,CAACC,aAAT,KAA2BN,gBAAgB,CAAC,CAAD,CAA/C,EAAoD;AAClDA,wBAAgB,CAAC,CAAD,CAAhB,CAAoBO,KAApB;AACD;;AACD;AACD;;AACD,QAAMC,aAAa,GAAGX,CAAC,CAACY,QAAxB;AACA,QAAMC,OAAO,GAAGb,CAAC,CAACc,MAAF,KAAaX,gBAAgB,CAAC,CAAD,CAA7C;AACA,QAAMY,MAAM,GAAGf,CAAC,CAACc,MAAF,KAAaX,gBAAgB,CAACA,gBAAgB,CAACD,MAAjB,GAA0B,CAA3B,CAA5C;;AACA,QAAIW,OAAO,IAAIF,aAAf,EAA8B;AAC5BX,OAAC,CAACO,cAAF;AACAJ,sBAAgB,CAACA,gBAAgB,CAACD,MAAjB,GAA0B,CAA3B,CAAhB,CAA8CQ,KAA9C;AACD;;AACD,QAAIK,MAAM,IAAI,CAACJ,aAAf,EAA8B;AAC5BX,OAAC,CAACO,cAAF;AACAJ,sBAAgB,CAAC,CAAD,CAAhB,CAAoBO,KAApB;AACD;;AACD,QAAIM,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,MAA7B,EAAqC;AACnC,UAAMC,KAAK,GAAGhB,gBAAgB,CAACiB,SAAjB,CAA2B,UAACC,OAAD;AAAA,eAAaA,OAAO,KAAKrB,CAAC,CAACc,MAA3B;AAAA,OAA3B,CAAd;;AACA,UAAIK,KAAK,KAAK,CAAC,CAAf,EAAkB;AAChB,SAAClB,EAAE,GAAGE,gBAAgB,CAACQ,aAAa,GAAGQ,KAAK,GAAG,CAAX,GAAeA,KAAK,GAAG,CAArC,CAAtB,KAAkE,IAAlE,GAAyE,KAAK,CAA9E,GAAkFlB,EAAE,CAACS,KAAH,EAAlF;AACD;AACF;AACF;AACF,CA/BD;;AAgCK,IAACY,SAAS,GAAG;AAChBC,aADgB,uBACJC,EADI,EACA;AACdA,MAAE,CAAC5B,kBAAD,CAAF,GAAyB6B,0BAA0B,CAACD,EAAD,CAAnD;AACA1B,eAAW,CAAC4B,IAAZ,CAAiBF,EAAjB;;AACA,QAAI1B,WAAW,CAACI,MAAZ,IAAsB,CAA1B,EAA6B;AAC3ByB,QAAE,CAACnB,QAAD,EAAW,SAAX,EAAsBT,aAAtB,CAAF;AACD;AACF,GAPe;AAQhB6B,SARgB,mBAQRJ,EARQ,EAQJ;AACVK,YAAQ,CAAC,YAAM;AACbL,QAAE,CAAC5B,kBAAD,CAAF,GAAyB6B,0BAA0B,CAACD,EAAD,CAAnD;AACD,KAFO,CAAR;AAGD,GAZe;AAahBM,WAbgB,uBAaJ;AACVhC,eAAW,CAACiC,KAAZ;;AACA,QAAIjC,WAAW,CAACI,MAAZ,KAAuB,CAA3B,EAA8B;AAC5B8B,SAAG,CAACxB,QAAD,EAAW,SAAX,EAAsBT,aAAtB,CAAH;AACD;AACF;AAlBe,CAAb","names":["FOCUSABLE_CHILDREN","TRAP_FOCUS_HANDLER","FOCUS_STACK","FOCUS_HANDLER","e","_a","length","focusableElement","code","EVENT_CODE","tab","preventDefault","document","activeElement","focus","goingBackward","shiftKey","isFirst","target","isLast","process","env","NODE_ENV","index","findIndex","element","TrapFocus","beforeMount","el","obtainAllFocusableElements","push","on","updated","nextTick","unmounted","shift","off"],"sources":["../../../../../packages/directives/trap-focus/index.ts"],"sourcesContent":["import { nextTick } from 'vue'\nimport { on, off, obtainAllFocusableElements } from '@element-plus/utils'\nimport { EVENT_CODE } from '@element-plus/constants'\nimport type { ObjectDirective } from 'vue'\n\nexport const FOCUSABLE_CHILDREN = '_trap-focus-children'\nexport const TRAP_FOCUS_HANDLER = '_trap-focus-handler'\n\nexport interface ITrapFocusElement extends HTMLElement {\n  [FOCUSABLE_CHILDREN]: HTMLElement[]\n  [TRAP_FOCUS_HANDLER]: (e: KeyboardEvent) => void\n}\n\nconst FOCUS_STACK = []\n\nconst FOCUS_HANDLER = (e: KeyboardEvent) => {\n  // Getting the top layer.\n  if (FOCUS_STACK.length === 0) return\n  const focusableElement =\n    FOCUS_STACK[FOCUS_STACK.length - 1][FOCUSABLE_CHILDREN]\n  if (focusableElement.length > 0 && e.code === EVENT_CODE.tab) {\n    if (focusableElement.length === 1) {\n      e.preventDefault()\n      if (document.activeElement !== focusableElement[0]) {\n        focusableElement[0].focus()\n      }\n      return\n    }\n    const goingBackward = e.shiftKey\n    const isFirst = e.target === focusableElement[0]\n    const isLast = e.target === focusableElement[focusableElement.length - 1]\n    if (isFirst && goingBackward) {\n      e.preventDefault()\n      focusableElement[focusableElement.length - 1].focus()\n    }\n    if (isLast && !goingBackward) {\n      e.preventDefault()\n      focusableElement[0].focus()\n    }\n\n    // the is critical since jsdom did not implement user actions, you can only mock it\n    // DELETE ME: when testing env switches to puppeteer\n    if (process.env.NODE_ENV === 'test') {\n      const index = focusableElement.findIndex(\n        (element: Element) => element === e.target\n      )\n      if (index !== -1) {\n        focusableElement[goingBackward ? index - 1 : index + 1]?.focus()\n      }\n    }\n  }\n}\n\nconst TrapFocus: ObjectDirective = {\n  beforeMount(el: ITrapFocusElement) {\n    el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el)\n    FOCUS_STACK.push(el)\n    if (FOCUS_STACK.length <= 1) {\n      on(document, 'keydown', FOCUS_HANDLER)\n    }\n  },\n  updated(el: ITrapFocusElement) {\n    nextTick(() => {\n      el[FOCUSABLE_CHILDREN] = obtainAllFocusableElements(el)\n    })\n  },\n  unmounted() {\n    FOCUS_STACK.shift()\n    if (FOCUS_STACK.length === 0) {\n      off(document, 'keydown', FOCUS_HANDLER)\n    }\n  },\n}\n\nexport default TrapFocus\n"]},"metadata":{},"sourceType":"module"}
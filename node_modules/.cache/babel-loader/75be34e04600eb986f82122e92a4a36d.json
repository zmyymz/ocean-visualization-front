{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.array.sort.js\";\n\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) {\n        if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n      }\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n/**\n * @module ol/renderer/Composite\n */\n\n\nimport MapRenderer from './Map.js';\nimport ObjectEventType from '../ObjectEventType.js';\nimport RenderEvent from '../render/Event.js';\nimport RenderEventType from '../render/EventType.js';\nimport SourceState from '../source/State.js';\nimport { CLASS_UNSELECTABLE } from '../css.js';\nimport { checkedFonts } from '../render/canvas.js';\nimport { inView } from '../layer/Layer.js';\nimport { listen, unlistenByKey } from '../events.js';\nimport { replaceChildren } from '../dom.js';\n/**\n * @classdesc\n * Canvas map renderer.\n * @api\n */\n\nvar CompositeMapRenderer =\n/** @class */\nfunction (_super) {\n  __extends(CompositeMapRenderer, _super);\n  /**\n   * @param {import(\"../PluggableMap.js\").default} map Map.\n   */\n\n\n  function CompositeMapRenderer(map) {\n    var _this = _super.call(this, map) || this;\n    /**\n     * @type {import(\"../events.js\").EventsKey}\n     */\n\n\n    _this.fontChangeListenerKey_ = listen(checkedFonts, ObjectEventType.PROPERTYCHANGE, map.redrawText.bind(map));\n    /**\n     * @private\n     * @type {HTMLDivElement}\n     */\n\n    _this.element_ = document.createElement('div');\n    var style = _this.element_.style;\n    style.position = 'absolute';\n    style.width = '100%';\n    style.height = '100%';\n    style.zIndex = '0';\n    _this.element_.className = CLASS_UNSELECTABLE + ' ol-layers';\n    var container = map.getViewport();\n    container.insertBefore(_this.element_, container.firstChild || null);\n    /**\n     * @private\n     * @type {Array<HTMLElement>}\n     */\n\n    _this.children_ = [];\n    /**\n     * @private\n     * @type {boolean}\n     */\n\n    _this.renderedVisible_ = true;\n    return _this;\n  }\n  /**\n   * @param {import(\"../render/EventType.js\").default} type Event type.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   */\n\n\n  CompositeMapRenderer.prototype.dispatchRenderEvent = function (type, frameState) {\n    var map = this.getMap();\n\n    if (map.hasListener(type)) {\n      var event_1 = new RenderEvent(type, undefined, frameState);\n      map.dispatchEvent(event_1);\n    }\n  };\n\n  CompositeMapRenderer.prototype.disposeInternal = function () {\n    unlistenByKey(this.fontChangeListenerKey_);\n    this.element_.parentNode.removeChild(this.element_);\n\n    _super.prototype.disposeInternal.call(this);\n  };\n  /**\n   * Render.\n   * @param {?import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   */\n\n\n  CompositeMapRenderer.prototype.renderFrame = function (frameState) {\n    if (!frameState) {\n      if (this.renderedVisible_) {\n        this.element_.style.display = 'none';\n        this.renderedVisible_ = false;\n      }\n\n      return;\n    }\n\n    this.calculateMatrices2D(frameState);\n    this.dispatchRenderEvent(RenderEventType.PRECOMPOSE, frameState);\n    var layerStatesArray = frameState.layerStatesArray.sort(function (a, b) {\n      return a.zIndex - b.zIndex;\n    });\n    var viewState = frameState.viewState;\n    this.children_.length = 0;\n    /**\n     * @type {Array<import(\"../layer/BaseVector.js\").default>}\n     */\n\n    var declutterLayers = [];\n    var previousElement = null;\n\n    for (var i = 0, ii = layerStatesArray.length; i < ii; ++i) {\n      var layerState = layerStatesArray[i];\n      frameState.layerIndex = i;\n      var layer = layerState.layer;\n      var sourceState = layer.getSourceState();\n\n      if (!inView(layerState, viewState) || sourceState != SourceState.READY && sourceState != SourceState.UNDEFINED) {\n        layer.unrender();\n        continue;\n      }\n\n      var element = layer.render(frameState, previousElement);\n\n      if (!element) {\n        continue;\n      }\n\n      if (element !== previousElement) {\n        this.children_.push(element);\n        previousElement = element;\n      }\n\n      if ('getDeclutter' in layer) {\n        declutterLayers.push(\n        /** @type {import(\"../layer/BaseVector.js\").default} */\n        layer);\n      }\n    }\n\n    for (var i = declutterLayers.length - 1; i >= 0; --i) {\n      declutterLayers[i].renderDeclutter(frameState);\n    }\n\n    replaceChildren(this.element_, this.children_);\n    this.dispatchRenderEvent(RenderEventType.POSTCOMPOSE, frameState);\n\n    if (!this.renderedVisible_) {\n      this.element_.style.display = '';\n      this.renderedVisible_ = true;\n    }\n\n    this.scheduleExpireIconCache(frameState);\n  };\n  /**\n   * @param {import(\"../pixel.js\").Pixel} pixel Pixel.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {function(import(\"../layer/Layer.js\").default<import(\"../source/Source\").default>, (Uint8ClampedArray|Uint8Array)): T} callback Layer\n   *     callback.\n   * @param {function(import(\"../layer/Layer.js\").default<import(\"../source/Source\").default>): boolean} layerFilter Layer filter\n   *     function, only layers which are visible and for which this function\n   *     returns `true` will be tested for features.  By default, all visible\n   *     layers will be tested.\n   * @return {T|undefined} Callback result.\n   * @template T\n   */\n\n\n  CompositeMapRenderer.prototype.forEachLayerAtPixel = function (pixel, frameState, hitTolerance, callback, layerFilter) {\n    var viewState = frameState.viewState;\n    var layerStates = frameState.layerStatesArray;\n    var numLayers = layerStates.length;\n\n    for (var i = numLayers - 1; i >= 0; --i) {\n      var layerState = layerStates[i];\n      var layer = layerState.layer;\n\n      if (layer.hasRenderer() && inView(layerState, viewState) && layerFilter(layer)) {\n        var layerRenderer = layer.getRenderer();\n        var data = layerRenderer.getDataAtPixel(pixel, frameState, hitTolerance);\n\n        if (data) {\n          var result = callback(layer, data);\n\n          if (result) {\n            return result;\n          }\n        }\n      }\n    }\n\n    return undefined;\n  };\n\n  return CompositeMapRenderer;\n}(MapRenderer);\n\nexport default CompositeMapRenderer;","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;;AAGA,OAAOA,WAAP,MAAwB,UAAxB;AACA,OAAOC,eAAP,MAA4B,uBAA5B;AACA,OAAOC,WAAP,MAAwB,oBAAxB;AACA,OAAOC,eAAP,MAA4B,wBAA5B;AACA,OAAOC,WAAP,MAAwB,oBAAxB;AACA,SAAQC,kBAAR,QAAiC,WAAjC;AACA,SAAQC,YAAR,QAA2B,qBAA3B;AACA,SAAQC,MAAR,QAAqB,mBAArB;AACA,SAAQC,MAAR,EAAgBC,aAAhB,QAAoC,cAApC;AACA,SAAQC,eAAR,QAA8B,WAA9B;AAEA;;;;;;AAKA;AAAA;AAAA;AAAmCC;AACjC;;;;;AAGA,gCAAYC,GAAZ,EAAe;AAAf,gBACEC,kBAAMD,GAAN,KAAU,IADZ;AAGE;;;;;AAGAE,SAAI,CAACC,sBAAL,GAA8BP,MAAM,CAClCF,YADkC,EAElCL,eAAe,CAACe,cAFkB,EAGlCJ,GAAG,CAACK,UAAJ,CAAeC,IAAf,CAAoBN,GAApB,CAHkC,CAApC;AAMA;;;;;AAIAE,SAAI,CAACK,QAAL,GAAgBC,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAAhB;AACA,QAAMC,KAAK,GAAGR,KAAI,CAACK,QAAL,CAAcG,KAA5B;AACAA,SAAK,CAACC,QAAN,GAAiB,UAAjB;AACAD,SAAK,CAACE,KAAN,GAAc,MAAd;AACAF,SAAK,CAACG,MAAN,GAAe,MAAf;AACAH,SAAK,CAACI,MAAN,GAAe,GAAf;AAEAZ,SAAI,CAACK,QAAL,CAAcQ,SAAd,GAA0BtB,kBAAkB,GAAG,YAA/C;AAEA,QAAMuB,SAAS,GAAGhB,GAAG,CAACiB,WAAJ,EAAlB;AACAD,aAAS,CAACE,YAAV,CAAuBhB,KAAI,CAACK,QAA5B,EAAsCS,SAAS,CAACG,UAAV,IAAwB,IAA9D;AAEA;;;;;AAIAjB,SAAI,CAACkB,SAAL,GAAiB,EAAjB;AAEA;;;;;AAIAlB,SAAI,CAACmB,gBAAL,GAAwB,IAAxB;;AACD;AAED;;;;;;AAIAC,iEAAoBC,IAApB,EAA0BC,UAA1B,EAAoC;AAClC,QAAMxB,GAAG,GAAG,KAAKyB,MAAL,EAAZ;;AACA,QAAIzB,GAAG,CAAC0B,WAAJ,CAAgBH,IAAhB,CAAJ,EAA2B;AACzB,UAAMI,OAAK,GAAG,IAAIrC,WAAJ,CAAgBiC,IAAhB,EAAsBK,SAAtB,EAAiCJ,UAAjC,CAAd;AACAxB,SAAG,CAAC6B,aAAJ,CAAkBF,OAAlB;AACD;AACF,GAND;;AAQAL;AACEzB,iBAAa,CAAC,KAAKM,sBAAN,CAAb;AACA,SAAKI,QAAL,CAAcuB,UAAd,CAAyBC,WAAzB,CAAqC,KAAKxB,QAA1C;;AACAN,qBAAM+B,eAAN,CAAqBC,IAArB,CAAqB,IAArB;AACD,GAJD;AAMA;;;;;;AAIAX,yDAAYE,UAAZ,EAAsB;AACpB,QAAI,CAACA,UAAL,EAAiB;AACf,UAAI,KAAKH,gBAAT,EAA2B;AACzB,aAAKd,QAAL,CAAcG,KAAd,CAAoBwB,OAApB,GAA8B,MAA9B;AACA,aAAKb,gBAAL,GAAwB,KAAxB;AACD;;AACD;AACD;;AAED,SAAKc,mBAAL,CAAyBX,UAAzB;AACA,SAAKY,mBAAL,CAAyB7C,eAAe,CAAC8C,UAAzC,EAAqDb,UAArD;AAEA,QAAMc,gBAAgB,GAAGd,UAAU,CAACc,gBAAX,CAA4BC,IAA5B,CAAiC,UAAUC,CAAV,EAAaC,CAAb,EAAc;AACtE,aAAOD,CAAC,CAAC1B,MAAF,GAAW2B,CAAC,CAAC3B,MAApB;AACD,KAFwB,CAAzB;AAGA,QAAM4B,SAAS,GAAGlB,UAAU,CAACkB,SAA7B;AAEA,SAAKtB,SAAL,CAAeuB,MAAf,GAAwB,CAAxB;AACA;;;;AAGA,QAAMC,eAAe,GAAG,EAAxB;AACA,QAAIC,eAAe,GAAG,IAAtB;;AACA,SAAK,IAAIC,CAAC,GAAG,CAAR,EAAWC,EAAE,GAAGT,gBAAgB,CAACK,MAAtC,EAA8CG,CAAC,GAAGC,EAAlD,EAAsD,EAAED,CAAxD,EAA2D;AACzD,UAAME,UAAU,GAAGV,gBAAgB,CAACQ,CAAD,CAAnC;AACAtB,gBAAU,CAACyB,UAAX,GAAwBH,CAAxB;AAEA,UAAMI,KAAK,GAAGF,UAAU,CAACE,KAAzB;AACA,UAAMC,WAAW,GAAGD,KAAK,CAACE,cAAN,EAApB;;AACA,UACE,CAACzD,MAAM,CAACqD,UAAD,EAAaN,SAAb,CAAP,IACCS,WAAW,IAAI3D,WAAW,CAAC6D,KAA3B,IACCF,WAAW,IAAI3D,WAAW,CAAC8D,SAH/B,EAIE;AACAJ,aAAK,CAACK,QAAN;AACA;AACD;;AAED,UAAMC,OAAO,GAAGN,KAAK,CAACO,MAAN,CAAajC,UAAb,EAAyBqB,eAAzB,CAAhB;;AACA,UAAI,CAACW,OAAL,EAAc;AACZ;AACD;;AACD,UAAIA,OAAO,KAAKX,eAAhB,EAAiC;AAC/B,aAAKzB,SAAL,CAAesC,IAAf,CAAoBF,OAApB;AACAX,uBAAe,GAAGW,OAAlB;AACD;;AACD,UAAI,kBAAkBN,KAAtB,EAA6B;AAC3BN,uBAAe,CAACc,IAAhB;AACE;AAAyDR,aAD3D;AAGD;AACF;;AACD,SAAK,IAAIJ,CAAC,GAAGF,eAAe,CAACD,MAAhB,GAAyB,CAAtC,EAAyCG,CAAC,IAAI,CAA9C,EAAiD,EAAEA,CAAnD,EAAsD;AACpDF,qBAAe,CAACE,CAAD,CAAf,CAAmBa,eAAnB,CAAmCnC,UAAnC;AACD;;AAED1B,mBAAe,CAAC,KAAKS,QAAN,EAAgB,KAAKa,SAArB,CAAf;AAEA,SAAKgB,mBAAL,CAAyB7C,eAAe,CAACqE,WAAzC,EAAsDpC,UAAtD;;AAEA,QAAI,CAAC,KAAKH,gBAAV,EAA4B;AAC1B,WAAKd,QAAL,CAAcG,KAAd,CAAoBwB,OAApB,GAA8B,EAA9B;AACA,WAAKb,gBAAL,GAAwB,IAAxB;AACD;;AAED,SAAKwC,uBAAL,CAA6BrC,UAA7B;AACD,GAlED;AAoEA;;;;;;;;;;;;;;;AAaAF,iEAAoBwC,KAApB,EAA2BtC,UAA3B,EAAuCuC,YAAvC,EAAqDC,QAArD,EAA+DC,WAA/D,EAA0E;AACxE,QAAMvB,SAAS,GAAGlB,UAAU,CAACkB,SAA7B;AAEA,QAAMwB,WAAW,GAAG1C,UAAU,CAACc,gBAA/B;AACA,QAAM6B,SAAS,GAAGD,WAAW,CAACvB,MAA9B;;AAEA,SAAK,IAAIG,CAAC,GAAGqB,SAAS,GAAG,CAAzB,EAA4BrB,CAAC,IAAI,CAAjC,EAAoC,EAAEA,CAAtC,EAAyC;AACvC,UAAME,UAAU,GAAGkB,WAAW,CAACpB,CAAD,CAA9B;AACA,UAAMI,KAAK,GAAGF,UAAU,CAACE,KAAzB;;AACA,UACEA,KAAK,CAACkB,WAAN,MACAzE,MAAM,CAACqD,UAAD,EAAaN,SAAb,CADN,IAEAuB,WAAW,CAACf,KAAD,CAHb,EAIE;AACA,YAAMmB,aAAa,GAAGnB,KAAK,CAACoB,WAAN,EAAtB;AACA,YAAMC,IAAI,GAAGF,aAAa,CAACG,cAAd,CACXV,KADW,EAEXtC,UAFW,EAGXuC,YAHW,CAAb;;AAKA,YAAIQ,IAAJ,EAAU;AACR,cAAME,MAAM,GAAGT,QAAQ,CAACd,KAAD,EAAQqB,IAAR,CAAvB;;AACA,cAAIE,MAAJ,EAAY;AACV,mBAAOA,MAAP;AACD;AACF;AACF;AACF;;AACD,WAAO7C,SAAP;AACD,GA7BD;;AA8BF;AAlLA,EAAmCxC,WAAnC;;AAoLA,eAAekC,oBAAf","names":["MapRenderer","ObjectEventType","RenderEvent","RenderEventType","SourceState","CLASS_UNSELECTABLE","checkedFonts","inView","listen","unlistenByKey","replaceChildren","__extends","map","_super","_this","fontChangeListenerKey_","PROPERTYCHANGE","redrawText","bind","element_","document","createElement","style","position","width","height","zIndex","className","container","getViewport","insertBefore","firstChild","children_","renderedVisible_","CompositeMapRenderer","type","frameState","getMap","hasListener","event_1","undefined","dispatchEvent","parentNode","removeChild","disposeInternal","call","display","calculateMatrices2D","dispatchRenderEvent","PRECOMPOSE","layerStatesArray","sort","a","b","viewState","length","declutterLayers","previousElement","i","ii","layerState","layerIndex","layer","sourceState","getSourceState","READY","UNDEFINED","unrender","element","render","push","renderDeclutter","POSTCOMPOSE","scheduleExpireIconCache","pixel","hitTolerance","callback","layerFilter","layerStates","numLayers","hasRenderer","layerRenderer","getRenderer","data","getDataAtPixel","result"],"sourceRoot":"","sources":["../src/renderer/Composite.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}
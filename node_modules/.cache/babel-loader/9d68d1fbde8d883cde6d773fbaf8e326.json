{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n/**\n * @module ol/renderer/canvas/VectorImageLayer\n */\n\n\nimport CanvasImageLayerRenderer from './ImageLayer.js';\nimport CanvasVectorLayerRenderer from './VectorLayer.js';\nimport EventType from '../../events/EventType.js';\nimport ImageCanvas from '../../ImageCanvas.js';\nimport ImageState from '../../ImageState.js';\nimport RBush from 'rbush';\nimport ViewHint from '../../ViewHint.js';\nimport { apply, compose, create } from '../../transform.js';\nimport { assign } from '../../obj.js';\nimport { getHeight, getWidth, isEmpty, scaleFromCenter } from '../../extent.js';\n/**\n * @classdesc\n * Canvas renderer for image layers.\n * @api\n */\n\nvar CanvasVectorImageLayerRenderer =\n/** @class */\nfunction (_super) {\n  __extends(CanvasVectorImageLayerRenderer, _super);\n  /**\n   * @param {import(\"../../layer/VectorImage.js\").default} layer Vector image layer.\n   */\n\n\n  function CanvasVectorImageLayerRenderer(layer) {\n    var _this = _super.call(this, layer) || this;\n    /**\n     * @private\n     * @type {import(\"./VectorLayer.js\").default}\n     */\n\n\n    _this.vectorRenderer_ = new CanvasVectorLayerRenderer(layer);\n    /**\n     * @private\n     * @type {number}\n     */\n\n    _this.layerImageRatio_ = layer.getImageRatio();\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n\n    _this.coordinateToVectorPixelTransform_ = create();\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n\n    _this.renderedPixelToCoordinateTransform_ = null;\n    return _this;\n  }\n  /**\n   * Clean up.\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.disposeInternal = function () {\n    this.vectorRenderer_.dispose();\n\n    _super.prototype.disposeInternal.call(this);\n  };\n  /**\n   * Asynchronous layer level hit detection.\n   * @param {import(\"../../pixel.js\").Pixel} pixel Pixel.\n   * @return {Promise<Array<import(\"../../Feature\").default>>} Promise that resolves with an array of features.\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.getFeatures = function (pixel) {\n    if (!this.vectorRenderer_) {\n      return new Promise(function (resolve) {\n        return resolve([]);\n      });\n    }\n\n    var vectorPixel = apply(this.coordinateToVectorPixelTransform_, apply(this.renderedPixelToCoordinateTransform_, pixel.slice()));\n    return this.vectorRenderer_.getFeatures(vectorPixel);\n  };\n  /**\n   * Perform action necessary to get the layer rendered after new fonts have loaded\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.handleFontsChanged = function () {\n    this.vectorRenderer_.handleFontsChanged();\n  };\n  /**\n   * Determine whether render should be called.\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @return {boolean} Layer is ready to be rendered.\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.prepareFrame = function (frameState) {\n    var pixelRatio = frameState.pixelRatio;\n    var viewState = frameState.viewState;\n    var viewResolution = viewState.resolution;\n    var hints = frameState.viewHints;\n    var vectorRenderer = this.vectorRenderer_;\n    var renderedExtent = frameState.extent;\n\n    if (this.layerImageRatio_ !== 1) {\n      renderedExtent = renderedExtent.slice(0);\n      scaleFromCenter(renderedExtent, this.layerImageRatio_);\n    }\n\n    var width = getWidth(renderedExtent) / viewResolution;\n    var height = getHeight(renderedExtent) / viewResolution;\n\n    if (!hints[ViewHint.ANIMATING] && !hints[ViewHint.INTERACTING] && !isEmpty(renderedExtent)) {\n      vectorRenderer.useContainer(null, null, 1);\n      var context = vectorRenderer.context;\n      var imageFrameState_1 =\n      /** @type {import(\"../../PluggableMap.js\").FrameState} */\n      assign({}, frameState, {\n        declutterTree: new RBush(9),\n        extent: renderedExtent,\n        size: [width, height],\n        viewState:\n        /** @type {import(\"../../View.js\").State} */\n        assign({}, frameState.viewState, {\n          rotation: 0\n        })\n      });\n      var emptyImage_1 = true;\n      var image_1 = new ImageCanvas(renderedExtent, viewResolution, pixelRatio, context.canvas, function (callback) {\n        if (vectorRenderer.prepareFrame(imageFrameState_1) && vectorRenderer.replayGroupChanged) {\n          vectorRenderer.clipping = false;\n\n          if (vectorRenderer.renderFrame(imageFrameState_1, null)) {\n            vectorRenderer.renderDeclutter(imageFrameState_1);\n            emptyImage_1 = false;\n          }\n\n          callback();\n        }\n      });\n      image_1.addEventListener(EventType.CHANGE, function () {\n        if (image_1.getState() !== ImageState.LOADED) {\n          return;\n        }\n\n        this.image_ = emptyImage_1 ? null : image_1;\n        var imageResolution = image_1.getResolution();\n        var imagePixelRatio = image_1.getPixelRatio();\n        var renderedResolution = imageResolution * pixelRatio / imagePixelRatio;\n        this.renderedResolution = renderedResolution;\n        this.coordinateToVectorPixelTransform_ = compose(this.coordinateToVectorPixelTransform_, width / 2, height / 2, 1 / renderedResolution, -1 / renderedResolution, 0, -viewState.center[0], -viewState.center[1]);\n      }.bind(this));\n      image_1.load();\n    }\n\n    if (this.image_) {\n      this.renderedPixelToCoordinateTransform_ = frameState.pixelToCoordinateTransform.slice();\n    }\n\n    return !!this.image_;\n  };\n  /**\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.preRender = function () {};\n  /**\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.postRender = function () {};\n  /**\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.renderDeclutter = function () {};\n  /**\n   * @param {import(\"../../coordinate.js\").Coordinate} coordinate Coordinate.\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {import(\"../vector.js\").FeatureCallback<T>} callback Feature callback.\n   * @param {Array<import(\"../Map.js\").HitMatch<T>>} matches The hit detected matches with tolerance.\n   * @return {T|undefined} Callback result.\n   * @template T\n   */\n\n\n  CanvasVectorImageLayerRenderer.prototype.forEachFeatureAtCoordinate = function (coordinate, frameState, hitTolerance, callback, matches) {\n    if (this.vectorRenderer_) {\n      return this.vectorRenderer_.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, matches);\n    } else {\n      return _super.prototype.forEachFeatureAtCoordinate.call(this, coordinate, frameState, hitTolerance, callback, matches);\n    }\n  };\n\n  return CanvasVectorImageLayerRenderer;\n}(CanvasImageLayerRenderer);\n\nexport default CanvasVectorImageLayerRenderer;","map":{"version":3,"mappings":"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","names":["CanvasImageLayerRenderer","CanvasVectorLayerRenderer","EventType","ImageCanvas","ImageState","RBush","ViewHint","apply","compose","create","assign","getHeight","getWidth","isEmpty","scaleFromCenter","__extends","layer","_super","_this","vectorRenderer_","layerImageRatio_","getImageRatio","coordinateToVectorPixelTransform_","renderedPixelToCoordinateTransform_","CanvasVectorImageLayerRenderer","dispose","disposeInternal","call","pixel","Promise","resolve","vectorPixel","slice","getFeatures","handleFontsChanged","frameState","pixelRatio","viewState","viewResolution","resolution","hints","viewHints","vectorRenderer","renderedExtent","extent","width","height","ANIMATING","INTERACTING","useContainer","context","imageFrameState_1","declutterTree","size","rotation","emptyImage_1","image_1","canvas","callback","prepareFrame","replayGroupChanged","clipping","renderFrame","renderDeclutter","addEventListener","CHANGE","getState","LOADED","image_","imageResolution","getResolution","imagePixelRatio","getPixelRatio","renderedResolution","center","bind","load","pixelToCoordinateTransform","coordinate","hitTolerance","matches","forEachFeatureAtCoordinate"],"sourceRoot":"","sources":["../../src/renderer/canvas/VectorImageLayer.js"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}